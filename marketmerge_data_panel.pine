//@version=6
indicator("MarketMerge Data Panel", overlay=false)

// ============================================================================
// MARKETMERGE DATA PANEL v1.5 — Compact Scoreboard Strip
// Single-row key metrics. Full detail lives on the chart overlay.
// ============================================================================

// === INPUTS ===
string rsBenchmark = input.symbol("SPY", "RS Benchmark")

// === COLORS ===
color labelColor  = color.new(#8899aa, 0)
color valueColor  = color.new(#e0e0e0, 0)
color greenColor  = color.new(#26a69a, 0)
color redColor    = color.new(#ef5350, 0)
color blueColor   = color.new(#42a5f5, 0)
color yellowColor = color.new(#ffb74d, 0)
color headerBg    = color.new(#16213e, 30)
color cellBg      = color.new(#1a1a2e, 50)

// === SYMINFO ===
string tickerId   = syminfo.tickerid
string tickerName = syminfo.ticker

// === DATA ===
float sharesOut    = request.financial(tickerId, "TOTAL_SHARES_OUTSTANDING", "FQ")
float epsAnnual    = request.financial(tickerId, "EARNINGS_PER_SHARE", "FY")
float revenueAnnual = request.financial(tickerId, "TOTAL_REVENUE", "FY")
float netIncome    = request.financial(tickerId, "NET_INCOME", "FY")
float totalEquity  = request.financial(tickerId, "TOTAL_EQUITY", "FY")
float epsQuarterly = request.financial(tickerId, "EARNINGS_PER_SHARE", "FQ")
float revenueQtr   = request.financial(tickerId, "TOTAL_REVENUE", "FQ")

bool annEpsChanged = bar_index > 0 and not na(epsAnnual) and (na(epsAnnual[1]) or epsAnnual != epsAnnual[1])
float epsAnnualPrev = ta.valuewhen(annEpsChanged, epsAnnual[1], 0)

bool epsChanged = bar_index > 0 and not na(epsQuarterly) and (na(epsQuarterly[1]) or epsQuarterly != epsQuarterly[1])
float epsQ_4 = ta.valuewhen(epsChanged, epsQuarterly[1], 3)
float epsQ_1 = ta.valuewhen(epsChanged, epsQuarterly[1], 0)
float epsQ_5 = ta.valuewhen(epsChanged, epsQuarterly[1], 4)

bool revChanged = bar_index > 0 and not na(revenueQtr) and (na(revenueQtr[1]) or revenueQtr != revenueQtr[1])
float revQ_4 = ta.valuewhen(revChanged, revenueQtr[1], 3)

float ma50  = ta.sma(close, 50)
float ma150 = ta.sma(close, 150)
float ma200 = ta.sma(close, 200)
float volMA50 = ta.sma(volume, 50)

float benchClose = request.security(rsBenchmark, timeframe.period, close)
float rsLine = benchClose > 0 ? (close / benchClose) : na

float stockRet63  = bar_index >= 63  ? (close - close[63])  / close[63]  * 100 : 0
float stockRet126 = bar_index >= 126 ? (close - close[126]) / close[126] * 100 : 0
float stockRet189 = bar_index >= 189 ? (close - close[189]) / close[189] * 100 : 0
float stockRet252 = bar_index >= 252 ? (close - close[252]) / close[252] * 100 : 0
float benchRet63  = bar_index >= 63  ? (benchClose - benchClose[63])  / benchClose[63]  * 100 : 0
float benchRet126 = bar_index >= 126 ? (benchClose - benchClose[126]) / benchClose[126] * 100 : 0
float benchRet189 = bar_index >= 189 ? (benchClose - benchClose[189]) / benchClose[189] * 100 : 0
float benchRet252 = bar_index >= 252 ? (benchClose - benchClose[252]) / benchClose[252] * 100 : 0

float rsRaw = (stockRet63 * 0.4 + stockRet126 * 0.2 + stockRet189 * 0.2 + stockRet252 * 0.2) - (benchRet63 * 0.4 + benchRet126 * 0.2 + benchRet189 * 0.2 + benchRet252 * 0.2)
int rsRating = math.round(math.max(1, math.min(99, 50 + rsRaw * 1.5)))

float epsQChg = (not na(epsQ_4) and math.abs(epsQ_4) > 0) ? ((epsQuarterly - epsQ_4) / math.abs(epsQ_4)) * 100 : na
float epsQ1Chg = (not na(epsQ_5) and math.abs(epsQ_5) > 0) ? ((epsQ_1 - epsQ_5) / math.abs(epsQ_5)) * 100 : na
float epsGrowthAnn = (not na(epsAnnualPrev) and math.abs(epsAnnualPrev) > 0) ? ((epsAnnual - epsAnnualPrev) / math.abs(epsAnnualPrev)) * 100 : na
float revQChg = (not na(revQ_4) and math.abs(revQ_4) > 0) ? ((revenueQtr - revQ_4) / math.abs(revQ_4)) * 100 : na
float margin = (not na(revenueAnnual) and revenueAnnual != 0) ? (netIncome / revenueAnnual) * 100 : na
float roe = totalEquity > 0 ? (netIncome / totalEquity) * 100 : na
float peRatio = epsAnnual > 0 ? close / epsAnnual : na
float high52 = ta.highest(high, 252)
float offHigh52 = ((close - high52) / high52) * 100

int epsRatingRaw = na(epsQChg) ? 50 : epsQChg > 100 ? 95 : epsQChg > 50 ? 85 : epsQChg > 25 ? 75 : epsQChg > 10 ? 60 : epsQChg > 0 ? 45 : epsQChg > -10 ? 30 : 15
int compositeRating = math.round((rsRating * 0.4) + (epsRatingRaw * 0.4) + (50 * 0.2))

float upVol   = close > close[1] ? volume : 0.0
float downVol = close < close[1] ? volume : 0.0
float udRatio = math.sum(downVol, 50) > 0 ? math.sum(upVol, 50) / math.sum(downVol, 50) : na
string adGrade = udRatio >= 1.5 ? "A" : udRatio >= 1.2 ? "B+" : udRatio >= 1.0 ? "B" : udRatio >= 0.8 ? "C+" : udRatio >= 0.6 ? "C" : udRatio >= 0.4 ? "D" : "E"

float smrScore = (not na(revQChg) and revQChg > 25 ? 30 : not na(revQChg) and revQChg > 10 ? 20 : 10) + (not na(margin) and margin > 20 ? 30 : not na(margin) and margin > 10 ? 20 : 10) + (not na(roe) and roe > 20 ? 30 : not na(roe) and roe > 10 ? 20 : 10)
string smrGrade = smrScore >= 80 ? "A" : smrScore >= 60 ? "B" : smrScore >= 40 ? "C" : "D"

bool trendOK = close > ma50 and close > ma150 and close > ma200 and ma50 > ma150 and ma150 > ma200
bool rsUp = rsLine > rsLine[20]
bool accel = not na(epsQChg) and not na(epsQ1Chg) and epsQChg > epsQ1Chg

// CANSLIM
bool cPass = not na(epsQChg) and epsQChg >= 25
bool aPass = not na(epsGrowthAnn) and epsGrowthAnn >= 25
bool nPass = offHigh52 >= -10
bool sPass = nz(udRatio) >= 1.0
bool lPass = rsRating >= 80
bool iPass = compositeRating >= 70
int score = (cPass ? 1 : 0) + (aPass ? 1 : 0) + (nPass ? 1 : 0) + (sPass ? 1 : 0) + (lPass ? 1 : 0) + (iPass ? 1 : 0)

// === HELPERS ===
getColor(float val, float hi, float mid) => val >= hi ? greenColor : val >= mid ? yellowColor : redColor
fmtPct(float val) => na(val) ? "—" : (val >= 0 ? "+" : "") + str.tostring(val, "#.#") + "%"

// === DUMMY PLOT ===
plot(0, "Base", color=color.new(color.white, 100), display=display.none)

// === SCOREBOARD: 2 rows × 20 cols ===
if barstate.islast
    var table p = table.new(position.bottom_left, 20, 2, bgcolor=cellBg, border_color=color.new(#334455, 80), border_width=1)

    // Mkt cap
    float mktCap = not na(sharesOut) ? close * sharesOut : na
    string mcStr = na(mktCap) ? "—" : mktCap >= 1e12 ? "$" + str.tostring(mktCap / 1e12, "#.##") + "T" : mktCap >= 1e9 ? "$" + str.tostring(mktCap / 1e9, "#.#") + "B" : "$" + str.tostring(mktCap / 1e6, "#.#") + "M"

    color scoreClr = score >= 5 ? greenColor : score >= 3 ? yellowColor : redColor
    string scoreLabel = score >= 5 ? "BUY ZONE" : score >= 3 ? "WATCH" : "AVOID"

    // === ROW 0: Labels ===
    table.cell(p, 0,  0, "Comp",    text_color=labelColor, text_size=size.tiny, bgcolor=headerBg)
    table.cell(p, 1,  0, "EPS Rtg", text_color=labelColor, text_size=size.tiny, bgcolor=headerBg)
    table.cell(p, 2,  0, "RS Rtg",  text_color=labelColor, text_size=size.tiny, bgcolor=headerBg)
    table.cell(p, 3,  0, "SMR",     text_color=labelColor, text_size=size.tiny, bgcolor=headerBg)
    table.cell(p, 4,  0, "A/D",     text_color=labelColor, text_size=size.tiny, bgcolor=headerBg)
    table.cell(p, 5,  0, "P/E",     text_color=labelColor, text_size=size.tiny, bgcolor=headerBg)
    table.cell(p, 6,  0, "Qtr EPS", text_color=labelColor, text_size=size.tiny, bgcolor=headerBg)
    table.cell(p, 7,  0, "Ann EPS", text_color=labelColor, text_size=size.tiny, bgcolor=headerBg)
    table.cell(p, 8,  0, "Rev Grw", text_color=labelColor, text_size=size.tiny, bgcolor=headerBg)
    table.cell(p, 9,  0, "Accel",   text_color=labelColor, text_size=size.tiny, bgcolor=headerBg)
    table.cell(p, 10, 0, "Margin",  text_color=labelColor, text_size=size.tiny, bgcolor=headerBg)
    table.cell(p, 11, 0, "ROE",     text_color=labelColor, text_size=size.tiny, bgcolor=headerBg)
    table.cell(p, 12, 0, "Off Hi",  text_color=labelColor, text_size=size.tiny, bgcolor=headerBg)
    table.cell(p, 13, 0, "RS Line", text_color=labelColor, text_size=size.tiny, bgcolor=headerBg)
    table.cell(p, 14, 0, "Trend",   text_color=labelColor, text_size=size.tiny, bgcolor=headerBg)
    table.cell(p, 15, 0, "MCap",    text_color=labelColor, text_size=size.tiny, bgcolor=headerBg)
    table.cell(p, 16, 0, "C", text_color=labelColor, text_size=size.tiny, bgcolor=headerBg)
    table.cell(p, 17, 0, "A", text_color=labelColor, text_size=size.tiny, bgcolor=headerBg)
    table.cell(p, 18, 0, "N·S·L·I", text_color=labelColor, text_size=size.tiny, bgcolor=headerBg)
    table.cell(p, 19, 0, "SCORE",   text_color=blueColor, text_size=size.tiny, bgcolor=headerBg)

    // === ROW 1: Values ===
    table.cell(p, 0,  1, str.tostring(compositeRating), text_color=getColor(compositeRating, 80, 60), text_size=size.small)
    table.cell(p, 1,  1, str.tostring(epsRatingRaw), text_color=getColor(epsRatingRaw, 80, 60), text_size=size.small)
    table.cell(p, 2,  1, str.tostring(rsRating), text_color=getColor(rsRating, 80, 60), text_size=size.small)
    color smrClr = smrScore >= 80 ? greenColor : smrScore >= 60 ? blueColor : smrScore >= 40 ? yellowColor : redColor
    table.cell(p, 3,  1, smrGrade, text_color=smrClr, text_size=size.small)
    color adClr = nz(udRatio) >= 1.2 ? greenColor : nz(udRatio) >= 0.8 ? yellowColor : redColor
    table.cell(p, 4,  1, adGrade, text_color=adClr, text_size=size.small)
    table.cell(p, 5,  1, na(peRatio) ? "—" : str.tostring(peRatio, "#.#"), text_color=valueColor, text_size=size.small)
    table.cell(p, 6,  1, fmtPct(epsQChg), text_color=nz(epsQChg) > 0 ? greenColor : redColor, text_size=size.small)
    table.cell(p, 7,  1, fmtPct(epsGrowthAnn), text_color=nz(epsGrowthAnn) > 0 ? greenColor : redColor, text_size=size.small)
    table.cell(p, 8,  1, fmtPct(revQChg), text_color=nz(revQChg) > 0 ? greenColor : redColor, text_size=size.small)
    table.cell(p, 9,  1, accel ? "YES ✓" : "NO", text_color=accel ? greenColor : redColor, text_size=size.small)
    color margClr = nz(margin) > 10 ? greenColor : nz(margin) > 0 ? yellowColor : redColor
    table.cell(p, 10, 1, na(margin) ? "—" : str.tostring(margin, "#.#") + "%", text_color=margClr, text_size=size.small)
    table.cell(p, 11, 1, na(roe) ? "—" : str.tostring(roe, "#.#") + "%", text_color=nz(roe) >= 17 ? greenColor : labelColor, text_size=size.small)
    table.cell(p, 12, 1, fmtPct(offHigh52), text_color=nz(offHigh52) >= -5 ? greenColor : nz(offHigh52) >= -15 ? yellowColor : redColor, text_size=size.small)
    table.cell(p, 13, 1, rsUp ? "▲ UP" : "▼ DN", text_color=rsUp ? greenColor : redColor, text_size=size.small)
    table.cell(p, 14, 1, trendOK ? "PASS ✓" : "FAIL", text_color=trendOK ? greenColor : redColor, text_size=size.small)
    table.cell(p, 15, 1, mcStr, text_color=valueColor, text_size=size.small)
    table.cell(p, 16, 1, cPass ? "✓" : "✗", text_color=cPass ? greenColor : redColor, text_size=size.small)
    table.cell(p, 17, 1, aPass ? "✓" : "✗", text_color=aPass ? greenColor : redColor, text_size=size.small)
    string nsli = (nPass ? "✓" : "✗") + " " + (sPass ? "✓" : "✗") + " " + (lPass ? "✓" : "✗") + " " + (iPass ? "✓" : "✗")
    table.cell(p, 18, 1, nsli, text_color=valueColor, text_size=size.small)
    table.cell(p, 19, 1, str.tostring(score) + "/6 " + scoreLabel, text_color=scoreClr, text_size=size.small)
