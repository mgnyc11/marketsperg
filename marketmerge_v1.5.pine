//@version=6
indicator("MarketMerge v1.5", overlay=true, max_labels_count=100)

// ============================================================================
// MARKETMERGE v1.5 — Chart Overlay Only
// MAs, RS line, S&P overlay, EPS markers — no data panel (see Data Panel)
// ============================================================================

// === INPUTS ===
string grp_rs = "Relative Strength & Benchmark"
string rsBenchmark = input.symbol("SPY", "RS Benchmark", group=grp_rs)
bool showRSline    = input.bool(true, "Show RS Line on Chart", group=grp_rs)
bool showSPYoverlay = input.bool(true, "Show S&P 500 Overlay", group=grp_rs)

string grp_ma = "Moving Averages"
bool showMA21  = input.bool(true, "Show 21 EMA", group=grp_ma)
bool showMA50  = input.bool(true, "Show 50 DMA", group=grp_ma)
bool showMA150 = input.bool(false, "Show 150 DMA", group=grp_ma)
bool showMA200 = input.bool(true, "Show 200 DMA", group=grp_ma)

bool showEPSmarkers = input.bool(true, "Show EPS Markers on Chart")

// === MOVING AVERAGES ===
float ema21 = ta.ema(close, 21)
float ma50  = ta.sma(close, 50)
float ma150 = ta.sma(close, 150)
float ma200 = ta.sma(close, 200)

plot(showMA21  ? ema21 : na, "21 EMA",  color=color.new(#e91e90, 0), linewidth=1)
plot(showMA50  ? ma50  : na, "50 DMA",  color=color.new(#ff0000, 0), linewidth=1)
plot(showMA150 ? ma150 : na, "150 DMA", color=color.new(#f0883e, 0), linewidth=1)
plot(showMA200 ? ma200 : na, "200 DMA", color=color.new(#000000, 0), linewidth=1)

// === BENCHMARK DATA ===
float benchClose = request.security(rsBenchmark, timeframe.period, close)

// === RELATIVE STRENGTH LINE ===
float rsLine = benchClose > 0 ? (close / benchClose) : na
float rsMA = ta.sma(rsLine, 50)
float rsScaled = na(rsLine) ? na : (rsLine / rsMA) * ma200
plot(showRSline ? rsScaled : na, "RS Line", color=color.new(#2196f3, 0), linewidth=1, style=plot.style_line)

// === S&P 500 OVERLAY ===
float spyClose = request.security("SPY", timeframe.period, close)
int refBars = math.min(bar_index, 100)
float stockRef = close[refBars]
float spyRef   = spyClose[refBars]
float spyPctChg = spyRef > 0 ? (spyClose / spyRef) : na
float spyNorm = not na(spyPctChg) and stockRef > 0 ? stockRef * spyPctChg : na
plot(showSPYoverlay ? spyNorm : na, "S&P 500", color=color.new(#888888, 60), linewidth=1, style=plot.style_line)

// === RS LINE NEW HIGH MARKER (current bar only) ===
float rsPriorHigh = ta.highest(rsLine[1], 252)
bool rsNewHigh = barstate.islast and not na(rsLine) and not na(rsPriorHigh) and rsLine > rsPriorHigh

if showRSline and rsNewHigh
    label.new(bar_index, rsScaled * 1.01, "RS\nNew High", color=color.new(#2196f3, 0), textcolor=color.white, style=label.style_label_down, size=size.tiny)

// === EPS MARKERS ON CHART ===
string tickerId = syminfo.tickerid
float epsActual = request.earnings(tickerId, earnings.actual, barmerge.gaps_on, barmerge.lookahead_off)

if showEPSmarkers and not na(epsActual)
    string epsLbl = "EPS\n$" + str.tostring(epsActual, "#.##")
    label.new(bar_index, low * 0.98, epsLbl,
         color=color.new(#26a69a, 0), textcolor=color.white,
         style=label.style_label_up, size=size.tiny)
